<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Money Manager Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Money Manager Analysis</h1>
      <a href="/stocks" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded shadow transition">
        Stocks
      </a>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-gray-500 text-sm">Net Cash Flow</h2>
        <p class="text-2xl font-bold text-green-600" id="netCashFlow">₹ 0</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-gray-500 text-sm">Last Month Income</h2>
        <p class="text-2xl font-bold text-blue-600" id="lmIncome">₹ 0</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-gray-500 text-sm">Last Month Expense</h2>
        <p class="text-2xl font-bold text-red-600" id="lmExpense">₹ 0</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-gray-500 text-sm">Last Month Savings</h2>
        <p class="text-2xl font-bold text-purple-600" id="lmSavings">₹ 0</p>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-semibold mb-4">Weekly Spending (Last Month)</h2>
        <canvas id="weeklyChart"></canvas>
      </div>
      <div class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-semibold mb-4">Expense Distribution by Category (Last Month)</h2>
        <canvas id="categoryChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Fetch processed data from the Flask backend instead of parsing the CSV client-side.
    async function loadAndProcessData() {
      try {
        const [summaryRes, weeklyRes, categoryRes] = await Promise.all([
          fetch('/api/summary'),
          fetch('/api/weekly-spending'),
          fetch('/api/category-breakdown')
        ]);

        if (!summaryRes.ok || !weeklyRes.ok || !categoryRes.ok) {
          throw new Error('Failed to fetch one or more API endpoints');
        }

        const summary = await summaryRes.json();
        const weekly = await weeklyRes.json(); // [{week: 'W1', amount: x}, ...]
        const categories = await categoryRes.json(); // [{category: 'Food', amount: x}, ...]

        const netCashFlow = Number(summary.net_cash_flow || 0);
        const lmIncome = Number((summary.last_month && summary.last_month.total_income) || 0);
        const lmExpense = Number((summary.last_month && summary.last_month.total_expense) || 0);
        const lmSavings = Number((summary.last_month && summary.last_month.net_savings) || (lmIncome - lmExpense));

        // Ensure weekly array is in W1..W4 order and numeric
        const weeklyMap = { 'W1': 0, 'W2': 0, 'W3': 0, 'W4': 0 };
        weekly.forEach(w => { if (w.week) weeklyMap[w.week] = Number(w.amount || 0); });
        const weeklyData = [weeklyMap['W1'], weeklyMap['W2'], weeklyMap['W3'], weeklyMap['W4']];

        // Category object for charts
        const categoryData = {};
        categories.forEach(c => {
          categoryData[c.category] = Number(c.amount || 0);
        });

        return { netCashFlow, lmIncome, lmExpense, lmSavings, weeklyData, categoryData };
      } catch (err) {
        console.error('Error loading data from API:', err);
        // Return zeros to avoid breaking the UI
        return { netCashFlow: 0, lmIncome: 0, lmExpense: 0, lmSavings: 0, weeklyData: [0,0,0,0], categoryData: {} };
      }
    }

    function updateUI(data) {
      document.getElementById('netCashFlow').textContent = `₹ ${data.netCashFlow.toLocaleString()}`;
      document.getElementById('lmIncome').textContent = `₹ ${data.lmIncome.toLocaleString()}`;
      document.getElementById('lmExpense').textContent = `₹ ${data.lmExpense.toLocaleString()}`;
      document.getElementById('lmSavings').textContent = `₹ ${data.lmSavings.toLocaleString()}`;

      // Weekly chart
      const ctx1 = document.getElementById('weeklyChart').getContext('2d');
      new Chart(ctx1, {
        type: 'line',
        data: {
          labels: ['W1', 'W2', 'W3', 'W4'],
          datasets: [{
            data: data.weeklyData,
            borderColor: '#3b82f6',
            backgroundColor: '#3b82f6',
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });

      // Category pie
      const ctx2 = document.getElementById('categoryChart').getContext('2d');
      new Chart(ctx2, {
        type: 'pie',
        data: {
          labels: Object.keys(data.categoryData),
          datasets: [{
            data: Object.values(data.categoryData),
            backgroundColor: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6', '#06b6d4']
          }]
        }
      });
    }

    loadAndProcessData().then(updateUI);
  </script>
</body>
</html>
